<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Anotador de Horas Extras</title>
    
    <!-- Tailwind CSS (via CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React e ReactDOM (via CDN) - Versões específicas para garantir compatibilidade -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    
    <!-- Babel (para converter JSX no navegador) -->
    <script src="https://unpkg.com/@babel/standalone@7.21.4/babel.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900">

    <!-- O React será renderizado aqui -->
    <div id="root"></div>

    <!-- 
      Configuração do Firebase
      As credenciais abaixo foram atualizadas com os seus dados.
    -->
    <script>
        // Configuração do Firebase - Credenciais atualizadas
        const __app_id = 'default-app-id'; // Pode manter este ou usar um ID específico
        
        // NOVO PROJETO - Anotador de Horas Extras
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyDpF7tRSkDGQ9UqmhkgDPx0h0Hdwiap2o8",
            authDomain: "anotador-horas-extras.firebaseapp.com",
            projectId: "anotador-horas-extras",
            storageBucket: "anotador-horas-extras.firebasestorage.app",
            messagingSenderId: "409284025895",
            appId: "1:409284025895:web:97a113da77c5bb65017802"
        });
        
        // PROJETO ANTIGO - Mantido como referência
        /*
        const __firebase_config = JSON.stringify({
            apiKey: "AIzaSyC_9d4m0crliSZvAd4py5exJixQFOtOvD8",
            authDomain: "fincontrole-70ec4.firebaseapp.com",
            projectId: "fincontrole-70ec4",
            storageBucket: "fincontrole-70ec4.appspot.com",
            messagingSenderId: "250535426531",
            appId: "1:250535426531:web:6f509f1ee9914a550188d6"
        });
        */
        
        const __initial_auth_token = null; 
    </script>

    <!-- O seu código da aplicação React -->
    <script type="text/babel" data-type="module">
        // Importar módulos do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, updateDoc, deleteDoc, doc, Timestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Desestruturar hooks do objeto React
        const { useState, useEffect, createContext, useContext, useMemo } = React;

        // --- Ícones ---
        const ClockIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>;
        const PlusIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const ListIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>;
        const PencilIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>;
        const Trash2Icon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>;
        const AlertTriangleIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>;
        const DownloadIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const LogOutIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>;

        const FirebaseContext = createContext(null);

        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const config = JSON.parse(__firebase_config);
                const firebaseApp = initializeApp(config);
                const firebaseAuth = getAuth(firebaseApp);
                const firestoreDb = getFirestore(firebaseApp);

                setAuth(firebaseAuth);
                setDb(firestoreDb);

                const unsubscribe = onAuthStateChanged(firebaseAuth, (user) => {
                    setUser(user);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, []);

            if (loading) {
                return (
                    <div className="flex flex-col justify-center items-center h-screen p-4">
                        <ClockIcon className="animate-spin h-12 w-12 text-indigo-600 mb-4" />
                        <p className="text-slate-600 dark:text-slate-300 text-center">Carregando aplicação...</p>
                        <p className="text-sm text-slate-500 dark:text-slate-400 text-center mt-2">
                            Se o carregamento persistir, verifique as regras de segurança do Firebase.
                            <br />Consulte o arquivo README.md para instruções.
                        </p>
                    </div>
                );
            }

            return (
                <FirebaseContext.Provider value={{ db, auth, user }}>
                    {user ? <OvertimeTracker /> : <AuthScreen />}
                </FirebaseContext.Provider>
            );
        };
        
        const AuthScreen = () => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const { auth } = useContext(FirebaseContext);

            const handleAuthAction = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                try {
                    if (isLogin) {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        await createUserWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    switch (err.code) {
                        case 'auth/user-not-found':
                        case 'auth/wrong-password':
                            setError('E-mail ou palavra-passe inválidos.');
                            break;
                        case 'auth/email-already-in-use':
                            setError('Este e-mail já está a ser utilizado.');
                            break;
                        case 'auth/weak-password':
                            setError('A palavra-passe deve ter pelo menos 6 caracteres.');
                            break;
                        default:
                            setError('Ocorreu um erro. Por favor, tente novamente.');
                            break;
                    }
                    console.error("Auth error:", err);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="flex items-center justify-center min-h-screen p-4">
                    <div className="w-full max-w-md p-8 space-y-6 bg-white dark:bg-slate-800 rounded-xl shadow-lg">
                        <div className="text-center">
                            <h1 className="text-3xl font-bold text-slate-900 dark:text-white">Bem-vindo</h1>
                            <p className="text-slate-500 dark:text-slate-400">{isLogin ? 'Inicie sessão para continuar' : 'Crie uma conta para começar'}</p>
                        </div>
                        
                        <div className="flex border-b border-slate-200 dark:border-slate-700">
                            <button onClick={() => setIsLogin(true)} className={`w-full p-4 text-sm font-medium transition-colors ${isLogin ? 'border-b-2 border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}>
                                Login
                            </button>
                            <button onClick={() => setIsLogin(false)} className={`w-full p-4 text-sm font-medium transition-colors ${!isLogin ? 'border-b-2 border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}>
                                Registar
                            </button>
                        </div>

                        <form onSubmit={handleAuthAction} className="space-y-4">
                            <input type="email" placeholder="E-mail" value={email} onChange={(e) => setEmail(e.target.value)} required className="form-input" />
                            <input type="password" placeholder="Palavra-passe" value={password} onChange={(e) => setPassword(e.target.value)} required className="form-input" />
                            
                            {error && <p className="text-sm text-red-600 dark:text-red-400 text-center">{error}</p>}

                            <button type="submit" disabled={loading} className="w-full flex justify-center py-2.5 px-4 border border-transparent rounded-lg shadow-sm text-sm font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors disabled:bg-indigo-400 disabled:cursor-not-allowed">
                                {loading ? <ClockIcon className="animate-spin h-5 w-5" /> : (isLogin ? 'Entrar' : 'Criar Conta')}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const OvertimeTracker = () => {
            const { db, user, auth } = useContext(FirebaseContext);
            const [overtimeEntries, setOvertimeEntries] = useState([]);
            const [showUnpaidOnly, setShowUnpaidOnly] = useState(false);
            const [filterDate, setFilterDate] = useState('');
            const [searchQuery, setSearchQuery] = useState('');
            const [activeTab, setActiveTab] = useState('add');
            const [message, setMessage] = useState({ text: '', type: '' });
            const [editingEntry, setEditingEntry] = useState(null);
            const [hourlyRate, setHourlyRate] = useState(0);
            const [nightlyPercentage, setNightlyPercentage] = useState(20);
            
            const updateNightlyPercentageInDb = async (newPercentage) => {
                if (!db || !user) return;
                
                try {
                    const userSettingsRef = doc(db, `artifacts/${appId}/users/${userId}/user_settings/preferences`);
                    await setDoc(userSettingsRef, { nightlyPercentage: parseFloat(newPercentage) || 20 }, { merge: true });
                    showMessage("Taxa de adicional noturno atualizada!", "success");
                } catch (error) {
                    console.error("Erro ao atualizar porcentagem noturna:", error);
                    showMessage("Erro ao salvar taxa de adicional noturno.", "error");
                }
            };

            const handleLogout = async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Logout failed:", error);
                }
            };
            
            useEffect(() => {
                if (!db || !user || !userId) return;
                
                // Usar as variáveis que já extraímos fora do useEffect
                const userSettingsRef = doc(db, `artifacts/${appId}/users/${userId}/user_settings/preferences`);
                const unsubscribeSettings = onSnapshot(userSettingsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setHourlyRate(docSnap.data().hourlyRate || 0);
                        setNightlyPercentage(docSnap.data().nightlyPercentage || 20);
                    } else {
                        setHourlyRate(0);
                        setNightlyPercentage(20);
                    }
                }, (error) => {
                    console.error("Erro ao buscar configurações:", error);
                    if (error.code === "permission-denied") {
                        showMessage("Erro de permissões no Firebase. Verifique as regras do Firestore.", "error");
                    }
                });

                const overtimeCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/overtime_entries`);
                let q = query(overtimeCollectionRef);
                if (showUnpaidOnly) {
                    q = query(overtimeCollectionRef, where("isPaid", "==", false));
                }
                const unsubscribeEntries = onSnapshot(q, (snapshot) => {
                    const entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    entries.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                    setOvertimeEntries(entries);
                }, (error) => {
                    console.error("Erro ao buscar horas extras:", error);
                    if (error.code === "permission-denied") {
                        showMessage("Erro de permissões no Firebase. Verifique as regras do Firestore.", "error");
                    } else {
                        showMessage("Erro ao carregar dados.", "error");
                    }
                });
                return () => {
                    unsubscribeSettings();
                    unsubscribeEntries();
                };
            }, [db, user, userId, showUnpaidOnly, appId]);

            const filteredEntries = useMemo(() => {
                return overtimeEntries.filter(entry => {
                    const dateMatch = !filterDate || (entry.date.split('T')[0] === filterDate);
                    const searchMatch = !searchQuery || entry.reason.toLowerCase().includes(searchQuery.toLowerCase());
                    return dateMatch && searchMatch;
                });
            }, [overtimeEntries, filterDate, searchQuery]);

            const { totalOvertime, totalValue } = useMemo(() => {
                const totalMinutes = filteredEntries.reduce((acc, entry) => acc + (entry.durationHours * 60) + entry.durationMinutes, 0);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                
                // Calcular o valor total considerando o adicional noturno
                let totalValue = 0;
                filteredEntries.forEach(entry => {
                    const entryHours = (entry.durationHours + (entry.durationMinutes / 60));
                    let entryValue = entryHours * hourlyRate;
                    
                    // Se tem adicional noturno, aplicar o percentual
                    if (entry.isNightShift) {
                        const percentage = entry.nightlyPercentage || 20;
                        const additionalValue = entryValue * (percentage / 100);
                        entryValue += additionalValue;
                    }
                    
                    totalValue += entryValue;
                });
                
                return {
                    totalOvertime: `${hours}h ${minutes}m`,
                    totalValue: totalValue.toFixed(2)
                };
            }, [filteredEntries, hourlyRate]);

            const showMessage = (text, type) => {
                setMessage({ text, type });
                setTimeout(() => setMessage({ text: '', type: '' }), 3000);
            };

            const exportToTxt = () => {
                if (filteredEntries.length === 0) {
                    showMessage("Não há dados para exportar.", "error");
                    return;
                }
                let content = `Relatório de Horas Extras - Total: ${totalOvertime} - Valor Estimado: R$ ${totalValue}\n\n`;
                filteredEntries.forEach((entry, index) => {
                    const formattedDate = new Date(entry.date + 'T00:00:00').toLocaleDateString('pt-BR');
                    const entryHours = (entry.durationHours + (entry.durationMinutes / 60));
                    let entryValue = entryHours * hourlyRate;
                    
                    // Calcular valor com adicional noturno se aplicável
                    if (entry.isNightShift) {
                        const percentage = entry.nightlyPercentage || 20;
                        const additionalValue = entryValue * (percentage / 100);
                        entryValue += additionalValue;
                    }
                    
                    content += `--- Entrada ${index + 1} ---\n`;
                    content += `Data: ${formattedDate} às ${entry.startTime}\n`;
                    content += `Duração: ${entry.durationHours}h ${entry.durationMinutes}m\n`;
                    content += `Motivo: ${entry.reason}\n`;
                    if (entry.isNightShift) {
                        content += `Adicional Noturno: ${entry.nightlyPercentage || 20}%\n`;
                    }
                    content += `Valor Estimado: R$ ${entryValue.toFixed(2)}\n`;
                    content += `Status: ${entry.isPaid ? 'Pago' : 'Não Pago'}\n`;
                    content += `Registrado em: ${entry.createdAt?.toDate().toLocaleString('pt-BR')}\n\n`;
                });
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `horas_extras_${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                showMessage("Dados exportados com sucesso!", "success");
            };

            // Extrair valores necessários fora das funções
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userId = user ? user.uid : null;
            
            const updateHourlyRateInDb = async (newRate) => {
                if (!db || !user) return;
                
                try {
                    const userSettingsRef = doc(db, `artifacts/${appId}/users/${userId}/user_settings/preferences`);
                    await setDoc(userSettingsRef, { hourlyRate: parseFloat(newRate) || 0 }, { merge: true });
                    showMessage("Taxa horária atualizada!", "success");
                } catch (error) {
                    console.error("Erro ao atualizar taxa horária:", error);
                    showMessage("Erro ao salvar taxa horária.", "error");
                }
            };

            return (
                <div className="max-w-4xl mx-auto">
                    {message.text && (
                        <div className={`fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white text-sm z-50 ${message.type === 'success' ? 'bg-green-500' : 'bg-red-500'}`}>
                            {message.text}
                        </div>
                    )}

                    <header className="mb-6">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center space-x-3">
                                <div className="bg-indigo-600 dark:bg-indigo-500 p-3 rounded-lg text-white">
                                    <ClockIcon />
                                </div>
                                <div>
                                    <h1 className="text-2xl sm:text-3xl font-bold text-slate-900 dark:text-white">Anotador de Horas Extras</h1>
                                    <p className="text-sm text-slate-500 dark:text-slate-400 truncate">{user.email}</p>
                                </div>
                            </div>
                            <button onClick={handleLogout} title="Sair" className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors">
                                <LogOutIcon />
                            </button>
                        </div>
                    </header>

                    <main className="flex flex-col lg:flex-row gap-6">
                        <div className="w-full lg:w-1/3 lg:flex-shrink-0 space-y-6">
                            <div className="flex bg-slate-200 dark:bg-slate-800 rounded-lg p-1">
                                <button onClick={() => { setActiveTab('add'); setEditingEntry(null); }} className={`w-full flex items-center justify-center space-x-2 p-2 rounded-md text-sm font-semibold transition-all ${activeTab === 'add' ? 'bg-white dark:bg-slate-700 text-indigo-600 dark:text-white shadow' : 'text-slate-600 dark:text-slate-300'}`}>
                                    <PlusIcon /> <span>{editingEntry ? 'Editar' : 'Adicionar'}</span>
                                </button>
                                <button onClick={() => setActiveTab('view')} className={`w-full flex items-center justify-center space-x-2 p-2 rounded-md text-sm font-semibold transition-all ${activeTab === 'view' ? 'bg-white dark:bg-slate-700 text-indigo-600 dark:text-white shadow' : 'text-slate-600 dark:text-slate-300'}`}>
                                    <ListIcon /> <span>Visualizar</span>
                                </button>
                            </div>

                            <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm">
                                {activeTab === 'add' ? (
                                    <OvertimeEntryForm 
                                        showMessage={showMessage} 
                                        editingEntry={editingEntry} 
                                        setEditingEntry={setEditingEntry} 
                                        setActiveTab={setActiveTab}
                                        defaultNightlyPercentage={nightlyPercentage} 
                                    />
                                ) : (
                                    <FilterControls 
                                        showUnpaidOnly={showUnpaidOnly} 
                                        setShowUnpaidOnly={setShowUnpaidOnly} 
                                        filterDate={filterDate} 
                                        setFilterDate={setFilterDate} 
                                        searchQuery={searchQuery} 
                                        setSearchQuery={setSearchQuery} 
                                        hourlyRate={hourlyRate} 
                                        setHourlyRate={setHourlyRate} 
                                        updateHourlyRateInDb={updateHourlyRateInDb}
                                        nightlyPercentage={nightlyPercentage}
                                        setNightlyPercentage={setNightlyPercentage}
                                        updateNightlyPercentageInDb={updateNightlyPercentageInDb}
                                    />
                                )}
                            </div>
                        </div>

                        <div className="w-full lg:w-2/3">
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                                <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-center">
                                    <p className="text-sm text-slate-500 dark:text-slate-400">Total de Horas</p>
                                    <p className="text-2xl font-bold text-indigo-600 dark:text-indigo-400">{totalOvertime}</p>
                                </div>
                                <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm text-center">
                                    <p className="text-sm text-slate-500 dark:text-slate-400">Valor Estimado</p>
                                    <p className="text-2xl font-bold text-green-600 dark:text-green-400">R$ {totalValue}</p>
                                </div>
                                 <button onClick={exportToTxt} className="w-full sm:col-span-2 bg-green-600 text-white font-semibold rounded-xl shadow-sm hover:bg-green-700 transition-colors flex items-center justify-center text-sm p-3 space-x-2">
                                    <DownloadIcon />
                                    <span>Exportar para TXT</span>
                                </button>
                            </div>
                            
                            <OvertimeList overtimeEntries={filteredEntries} showMessage={showMessage} setEditingEntry={setEditingEntry} setActiveTab={setActiveTab} />
                        </div>
                    </main>
                </div>
            );
        };

        const OvertimeEntryForm = ({ showMessage, editingEntry, setEditingEntry, setActiveTab, defaultNightlyPercentage = 20 }) => {
            const { db, user } = useContext(FirebaseContext);
            const [date, setDate] = useState('');
            const [startTime, setStartTime] = useState('');
            const [durationHours, setDurationHours] = useState('');
            const [durationMinutes, setDurationMinutes] = useState('');
            const [reason, setReason] = useState('');
            const [isPaid, setIsPaid] = useState(false);
            const [isNightShift, setIsNightShift] = useState(false);
            // Usar o valor padrão fornecido pelo componente pai
            const [nightlyPercentage, setNightlyPercentage] = useState(defaultNightlyPercentage);
            
            // Handlers para os eventos de formulário
            const handleDateChange = (e) => setDate(e.target.value);
            const handleStartTimeChange = (e) => setStartTime(e.target.value);
            const handleDurationHoursChange = (e) => setDurationHours(e.target.value);
            const handleDurationMinutesChange = (e) => setDurationMinutes(e.target.value);
            const handleReasonChange = (e) => setReason(e.target.value);
            const handleIsPaidChange = (e) => setIsPaid(e.target.checked);
            const handleIsNightShiftChange = (e) => setIsNightShift(e.target.checked);
            
            // Atualizar quando o valor padrão mudar
            useEffect(() => {
                setNightlyPercentage(defaultNightlyPercentage);
            }, [defaultNightlyPercentage]);

            useEffect(() => {
                if (editingEntry) {
                    setDate(editingEntry.date);
                    setStartTime(editingEntry.startTime);
                    setDurationHours(editingEntry.durationHours);
                    setDurationMinutes(editingEntry.durationMinutes);
                    setReason(editingEntry.reason);
                    setIsPaid(editingEntry.isPaid);
                    setIsNightShift(editingEntry.isNightShift || false);
                } else {
                    const now = new Date();
                    const localISO = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString();
                    setDate(localISO.split('T')[0]);
                    setStartTime(localISO.split('T')[1].substring(0, 5));
                    setDurationHours('');
                    setDurationMinutes('');
                    setReason('');
                    setIsPaid(false);
                    setIsNightShift(false);
                }
            }, [editingEntry]);

            // Extrair valores necessários fora das funções
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userId = user ? user.uid : null;
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!db || !user || !userId) return showMessage("Erro de conexão.", "error");
                if (!date || !startTime || durationHours === '' || durationMinutes === '' || !reason) {
                    return showMessage("Preencha todos os campos.", "error");
                }
                if (isNaN(parseInt(durationHours)) || isNaN(parseInt(durationMinutes)) || parseInt(durationHours) < 0 || parseInt(durationMinutes) < 0 || parseInt(durationMinutes) > 59) {
                    return showMessage("Duração inválida.", "error");
                }
                const dataToSave = {
                    date,
                    startTime,
                    durationHours: parseInt(durationHours),
                    durationMinutes: parseInt(durationMinutes),
                    reason,
                    isPaid,
                    isNightShift,
                    nightlyPercentage: isNightShift ? nightlyPercentage : 0,
                    createdAt: editingEntry ? editingEntry.createdAt : Timestamp.now(),
                };

                try {
                    if (editingEntry) {
                        const entryRef = doc(db, `artifacts/${appId}/users/${userId}/overtime_entries`, editingEntry.id);
                        await updateDoc(entryRef, dataToSave);
                        showMessage("Entrada atualizada!", "success");
                        setEditingEntry(null);
                        setActiveTab('view');
                    } else {
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/overtime_entries`), dataToSave);
                        showMessage("Hora extra adicionada!", "success");
                        const now = new Date();
                        const localISO = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString();
                        setDate(localISO.split('T')[0]);
                        setStartTime(localISO.split('T')[1].substring(0, 5));
                        setDurationHours('');
                        setDurationMinutes('');
                        setReason('');
                        setIsPaid(false);
                    }
                } catch (error) {
                    console.error("Erro ao salvar:", error);
                    showMessage("Erro ao salvar a entrada.", "error");
                }
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <h2 className="text-lg font-bold text-slate-800 dark:text-white">{editingEntry ? 'Editar Hora Extra' : 'Adicionar Nova Hora Extra'}</h2>
                    <div>
                        <label htmlFor="date" className="block text-sm font-medium text-slate-600 dark:text-slate-300">Data</label>
                        <input type="date" id="date" value={date} onChange={handleDateChange} required className="form-input" />
                    </div>
                    <div>
                        <label htmlFor="startTime" className="block text-sm font-medium text-slate-600 dark:text-slate-300">Hora de Início</label>
                        <input type="time" id="startTime" value={startTime} onChange={handleStartTimeChange} required className="form-input" />
                    </div>
                    <div className="flex space-x-4">
                        <div className="flex-1">
                            <label htmlFor="durationHours" className="block text-sm font-medium text-slate-600 dark:text-slate-300">Horas</label>
                            <input type="number" id="durationHours" value={durationHours} onChange={handleDurationHoursChange} min="0" required className="form-input" />
                        </div>
                        <div className="flex-1">
                            <label htmlFor="durationMinutes" className="block text-sm font-medium text-slate-600 dark:text-slate-300">Minutos</label>
                            <input type="number" id="durationMinutes" value={durationMinutes} onChange={handleDurationMinutesChange} min="0" max="59" required className="form-input" />
                        </div>
                    </div>
                    <div>
                        <label htmlFor="reason" className="block text-sm font-medium text-slate-600 dark:text-slate-300">Motivo</label>
                        <textarea id="reason" value={reason} onChange={handleReasonChange} rows="3" required className="form-input resize-y"></textarea>
                    </div>
                    <div className="flex items-center mb-2">
                        <input 
                            type="checkbox" 
                            id="isNightShift" 
                            checked={isNightShift} 
                            onChange={handleIsNightShiftChange} 
                            className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-slate-300 dark:border-slate-600 rounded" 
                        />
                        <label htmlFor="isNightShift" className="ml-2 block text-sm text-slate-600 dark:text-slate-300">
                            Adicional noturno ({nightlyPercentage}%)
                        </label>
                    </div>
                    <div className="flex items-center">
                        <input 
                            type="checkbox" 
                            id="isPaid" 
                            checked={isPaid} 
                            onChange={handleIsPaidChange} 
                            className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-slate-300 dark:border-slate-600 rounded" 
                        />
                        <label htmlFor="isPaid" className="ml-2 block text-sm text-slate-600 dark:text-slate-300">Já foi pago?</label>
                    </div>
                    <button type="submit" className="w-full flex justify-center py-2.5 px-4 border border-transparent rounded-lg shadow-sm text-sm font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                        {editingEntry ? 'Atualizar Entrada' : 'Adicionar Entrada'}
                    </button>
                    {editingEntry && (
                        <button type="button" onClick={() => { setEditingEntry(null); setActiveTab('view'); }} className="w-full text-center py-2 px-4 text-sm font-semibold text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors mt-2">
                            Cancelar Edição
                        </button>
                    )}
                </form>
            );
        };

        const FilterControls = ({ showUnpaidOnly, setShowUnpaidOnly, filterDate, setFilterDate, searchQuery, setSearchQuery, hourlyRate, setHourlyRate, updateHourlyRateInDb, nightlyPercentage, setNightlyPercentage, updateNightlyPercentageInDb }) => {
            // Função simples para lidar com a mudança de taxa horária
            const handleHourlyRateChange = (e) => {
                const value = e.target.value;
                setHourlyRate(value);
            };
            
            // Função simples para lidar com o blur da taxa horária
            const handleHourlyRateBlur = (e) => {
                const value = e.target.value;
                updateHourlyRateInDb(value);
            };
            
            // Função simples para lidar com a mudança de percentual noturno
            const handleNightlyPercentageChange = (e) => {
                const value = e.target.value;
                setNightlyPercentage(value);
            };
            
            // Função simples para lidar com o blur do percentual noturno
            const handleNightlyPercentageBlur = (e) => {
                const value = e.target.value;
                updateNightlyPercentageInDb(value);
            };
            
            return (
                <div className="space-y-4">
                    <h2 className="text-lg font-bold text-slate-800 dark:text-white">Opções e Filtros</h2>
                     <div>
                        <label htmlFor="hourlyRate" className="block text-sm font-medium text-slate-600 dark:text-slate-300">Taxa Horária (R$)</label>
                        <input 
                            type="number" 
                            id="hourlyRate" 
                            value={hourlyRate} 
                            onChange={handleHourlyRateChange} 
                            onBlur={handleHourlyRateBlur} 
                            step="0.01" 
                            min="0" 
                            className="form-input" 
                        />
                    </div>
                    <div>
                        <label htmlFor="nightlyPercentage" className="block text-sm font-medium text-slate-600 dark:text-slate-300">Adicional Noturno (%)</label>
                        <input 
                            type="number" 
                            id="nightlyPercentage" 
                            value={nightlyPercentage} 
                            onChange={handleNightlyPercentageChange} 
                            onBlur={handleNightlyPercentageBlur} 
                            step="1" 
                            min="0" 
                            max="100" 
                            className="form-input" 
                        />
                    </div>
                    <div>
                        <label htmlFor="searchReason" className="block text-sm font-medium text-slate-600 dark:text-slate-300">Pesquisar Motivo</label>
                        <input type="text" id="searchReason" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} placeholder="Ex: projeto final..." className="form-input" />
                    </div>
                    <div>
                        <label htmlFor="filterDate" className="block text-sm font-medium text-slate-600 dark:text-slate-300">Filtrar por Data</label>
                        <input type="date" id="filterDate" value={filterDate} onChange={(e) => setFilterDate(e.target.value)} className="form-input" />
                    </div>
                    <div className="flex items-center">
                        <input type="checkbox" id="filterUnpaid" checked={showUnpaidOnly} onChange={(e) => setShowUnpaidOnly(e.target.checked)} className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-slate-300 dark:border-slate-600 rounded" />
                        <label htmlFor="filterUnpaid" className="ml-2 block text-sm text-slate-600 dark:text-slate-300">Mostrar somente não pagas</label>
                    </div>
                </div>
            );
        };

        const OvertimeList = ({ overtimeEntries, showMessage, setEditingEntry, setActiveTab }) => {
            const { db, user } = useContext(FirebaseContext);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [entryToDelete, setEntryToDelete] = useState(null);

            const handleDeleteClick = (entry) => {
                setEntryToDelete(entry);
                setIsModalOpen(true);
            };

            const handleConfirmDelete = async () => {
                if (!entryToDelete) return;
                
                // Não use useContext dentro de uma função normal
                // Em vez disso, use a referência que já capturamos no componente
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                if (!db || !user) return showMessage("Erro de conexão.", "error");
                const userId = user.uid;

                try {
                    const entryRef = doc(db, `artifacts/${appId}/users/${userId}/overtime_entries`, entryToDelete.id);
                    await deleteDoc(entryRef);
                    showMessage("Entrada excluída!", "success");
                } catch (error) {
                    console.error("Erro ao excluir:", error);
                    showMessage("Erro ao excluir entrada.", "error");
                } finally {
                    setIsModalOpen(false);
                    setEntryToDelete(null);
                }
            };

            return (
                <div className="space-y-4">
                    {overtimeEntries.length === 0 ? (
                        <div className="text-center py-10 px-4 bg-white dark:bg-slate-800 rounded-xl shadow-sm">
                            <ListIcon className="mx-auto h-12 w-12 text-slate-400" />
                            <h3 className="mt-2 text-lg font-semibold text-slate-800 dark:text-white">Nenhuma entrada encontrada</h3>
                            <p className="mt-1 text-sm text-slate-500 dark:text-slate-400">Tente ajustar os seus filtros ou adicione uma nova hora extra.</p>
                        </div>
                    ) : (
                        overtimeEntries.map(entry => (
                            <OvertimeItem key={entry.id} entry={entry} showMessage={showMessage} setEditingEntry={setEditingEntry} setActiveTab={setActiveTab} onDeleteClick={handleDeleteClick} />
                        ))
                    )}
                    <ConfirmationModal isOpen={isModalOpen} message="Tem a certeza de que deseja excluir esta entrada? Esta ação não pode ser desfeita." onConfirm={handleConfirmDelete} onCancel={() => setIsModalOpen(false)} />
                </div>
            );
        };

        const OvertimeItem = ({ entry, showMessage, setEditingEntry, setActiveTab, onDeleteClick }) => {
            const { db, user } = useContext(FirebaseContext);
            
            // Extrair valores necessários fora da função de evento
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const userId = user ? user.uid : null;

            const togglePaidStatus = async () => {
                if (!db || !user) return showMessage("Erro de conexão.", "error");
                
                try {
                    const entryRef = doc(db, `artifacts/${appId}/users/${userId}/overtime_entries`, entry.id);
                    await updateDoc(entryRef, { isPaid: !entry.isPaid });
                    showMessage("Status de pagamento atualizado.", "success");
                } catch (error) {
                    console.error("Erro ao atualizar status:", error);
                    showMessage("Erro ao atualizar status.", "error");
                }
            };

            const handleEdit = () => {
                setEditingEntry(entry);
                setActiveTab('add');
            };

            const formattedDate = new Date(entry.date + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });

            return (
                <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm transition-all hover:shadow-md">
                    <div className="flex flex-col sm:flex-row sm:justify-between sm:items-start">
                        <div className="flex-grow">
                            <p className="font-bold text-slate-800 dark:text-white">{entry.reason}</p>
                            <p className="text-sm text-slate-500 dark:text-slate-400">{formattedDate} às {entry.startTime}</p>
                            <p className="text-sm text-slate-500 dark:text-slate-400">Duração: <span className="font-medium text-slate-700 dark:text-slate-300">{entry.durationHours}h {entry.durationMinutes}m</span></p>
                            {entry.isNightShift && (
                                <p className="text-sm text-blue-500 dark:text-blue-400">
                                    <span className="font-medium">Adicional noturno: {entry.nightlyPercentage || 20}%</span>
                                </p>
                            )}
                        </div>
                        <div className="flex-shrink-0 mt-3 sm:mt-0 sm:ml-4">
                             <button onClick={togglePaidStatus} className={`w-full sm:w-auto px-3 py-1 text-xs font-bold rounded-full transition-colors ${entry.isPaid ? 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300'}`}>
                                {entry.isPaid ? 'PAGO' : 'PENDENTE'}
                            </button>
                        </div>
                    </div>
                    <div className="flex justify-between items-center mt-3 pt-3 border-t border-slate-100 dark:border-slate-700">
                         <p className="text-xs text-slate-400 dark:text-slate-500">
                            Registado em: {entry.createdAt?.toDate().toLocaleDateString('pt-BR')}
                        </p>
                        <div className="flex items-center space-x-2">
                            <button onClick={handleEdit} title="Editar" className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors">
                                <PencilIcon />
                            </button>
                            <button onClick={() => onDeleteClick(entry)} title="Excluir" className="p-2 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 text-red-500 transition-colors">
                                <Trash2Icon />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const ConfirmationModal = ({ isOpen, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center p-4 z-50 backdrop-blur-sm">
                    <div className="bg-white dark:bg-slate-800 rounded-xl p-6 shadow-xl max-w-sm w-full text-center transform transition-all" role="dialog" aria-modal="true">
                        <AlertTriangleIcon className="mx-auto h-12 w-12 text-red-500 mb-4" />
                        <h3 className="text-lg font-semibold text-slate-900 dark:text-white">Atenção</h3>
                        <p className="text-sm text-slate-500 dark:text-slate-400 mt-2 mb-6">{message}</p>
                        <div className="flex justify-center space-x-4">
                            <button onClick={onCancel} className="px-6 py-2 rounded-lg bg-slate-200 text-slate-800 font-semibold hover:bg-slate-300 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600 transition-colors">
                                Cancelar
                            </button>
                            <button onClick={onConfirm} className="px-6 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors">
                                Confirmar Exclusão
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const GlobalStyles = () => (
          <style>{`
            .form-input {
              display: block;
              width: 100%;
              margin-top: 0.25rem;
              padding: 0.5rem 0.75rem;
              border: 1px solid;
              border-radius: 0.5rem;
              box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
              transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            }
            .form-input:focus {
              outline: none;
              --tw-ring-color: #4f46e5; /* indigo-600 */
              box-shadow: 0 0 0 2px var(--tw-ring-color);
              border-color: #4f46e5;
            }
            .dark .form-input {
              background-color: #334155; /* slate-700 */
              border-color: #475569; /* slate-600 */
              color: #f8fafc; /* slate-50 */
            }
            .light .form-input {
              background-color: #f8fafc; /* slate-50 */
              border-color: #cbd5e1; /* slate-300 */
              color: #0f172a; /* slate-900 */
            }
          `}</style>
        );

        const AppWithStyles = () => (
          <>
            <GlobalStyles />
            <App />
          </>
        );

        // --- Fim do seu código React ---

        // Renderizar a aplicação no elemento 'root' usando a API do React 18
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        
        // Envolver em um try-catch para capturar erros de renderização
        try {
            root.render(
                // StrictMode ajuda a identificar problemas no código
                <React.StrictMode>
                    <AppWithStyles />
                </React.StrictMode>
            );
        } catch (error) {
            console.error("Erro ao renderizar o aplicativo:", error);
            // Mostrar uma mensagem de erro amigável no DOM
            container.innerHTML = `
                <div style="text-align: center; margin-top: 50px; font-family: Arial, sans-serif;">
                    <h2>Erro ao carregar o aplicativo</h2>
                    <p>Ocorreu um erro ao inicializar o aplicativo. Por favor, verifique o console para mais detalhes.</p>
                    <p style="color: red;">${error.message}</p>
                </div>
            `;
        }

    </script>

</body>
</html>
